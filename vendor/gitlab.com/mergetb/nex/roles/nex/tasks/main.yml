# nex configuration entry point
---

- name: ensure merge config directory exists
  file:
    path: /etc/merge
    state: directory

- name: set default nex config
  copy:
    src: config.yml
    dest: /etc/merge/nex.yml

- name: add merge dnf repo
  copy:
    src: merge.repo
    dest: /etc/yum.repos.d/merge.repo

- name: import merge dnf repo key
  shell: rpm --import https://build.mergetb.net/rpm/MergeTB-GPG-Public


# requires refresh since we just added repo and dnf ansible module does not
# have this option
- name: install nex package
  shell: dnf install -y nex-dhcp-dns --refresh


- name: apply custom nex rpm
  copy:
    src: "{{nex_rpm}}"
    dest: /tmp/nex-dhcp-dns.rpm
    remote_src: "{{nex_rpm_remote}}"
  when: nex_rpm is defined

- name: install custom nex rpm
  shell: dnf -y reinstall /tmp/nex-dhcp-dns.rpm
  when: nex_rpm is defined

- systemd:
    daemon_reload: yes


- name: restart nex-dhcpd
  service:
    name: nex-dhcpd
    enabled: true
    state: restarted

- name: create coredns config directory
  file:
    path: /etc/coredns
    state: directory

- name: copy coredns config
  copy:
    src: Corefile
    dest: /etc/coredns/Corefile

- name: restart coredns
  service:
    name: coredns
    enabled: true
    state: restarted

- name: restart nexd
  service:
    name: nexd
    enabled: true
    state: restarted
